[gd_scene load_steps=17 format=2]

[ext_resource path="res://sprites/hub/blue_circle_empty.png" type="Texture" id=1]
[ext_resource path="res://scripts/Room2D/Room2D.gd" type="Script" id=2]
[ext_resource path="res://scenes/2d/character & player/npc.tscn" type="PackedScene" id=3]
[ext_resource path="res://sprites/hub/dark_background.png" type="Texture" id=4]
[ext_resource path="res://scenes/2d/interactable/interactable_warp_2d.tscn" type="PackedScene" id=5]
[ext_resource path="res://scenes/2d/collision grid/solid_grid_2d.tscn" type="PackedScene" id=6]
[ext_resource path="res://sprites/hub/small_pink_particles.png" type="Texture" id=7]
[ext_resource path="res://sprites/hub/big_blue_particles2.png" type="Texture" id=8]
[ext_resource path="res://sprites/hub/small_blue_particles.png" type="Texture" id=9]
[ext_resource path="res://sprites/hub/big_pink_particles2.png" type="Texture" id=10]
[ext_resource path="res://sprites/hub/hub shape gradient.png" type="Texture" id=11]
[ext_resource path="res://sprites/hub/circle.png" type="Texture" id=12]
[ext_resource path="res://sprites/hub/hub_pattern.png" type="Texture" id=14]
[ext_resource path="res://scripts/Piano Minigame/Rotation_non_tool.gd" type="Script" id=15]

[sub_resource type="Shader" id=3]
code = "shader_type canvas_item;

uniform vec4 light_color : hint_color = vec4(1., 1., 1., 1.);
uniform vec4 dark_color : hint_color = vec4(0., 0., 0., 1.);

vec2 random(vec2 uv){
    uv = vec2( dot(uv, vec2(127.1,311.7) ),
               dot(uv, vec2(269.5,183.3) ) );
    return -1.0 + 2.0 * fract(sin(uv) * 43758.5453123);
}

float noise(vec2 uv) {
    vec2 uv_index = floor(uv);
    vec2 uv_fract = fract(uv);

    vec2 blur = smoothstep(0.0, 1.0, uv_fract);

    return mix( mix( dot( random(uv_index + vec2(0.0,0.0) ), uv_fract - vec2(0.0,0.0) ),
                     dot( random(uv_index + vec2(1.0,0.0) ), uv_fract - vec2(1.0,0.0) ), blur.x),
                mix( dot( random(uv_index + vec2(0.0,1.0) ), uv_fract - vec2(0.0,1.0) ),
                     dot( random(uv_index + vec2(1.0,1.0) ), uv_fract - vec2(1.0,1.0) ), blur.x), blur.y) + 0.5;
}

uniform float noisiness : hint_range(0.0, 64.0) = 32.0;
uniform float added_threshold : hint_range(0.0, 1.0) = 0.1;
uniform float hole_factor : hint_range(0.0, 1.0) = 0.5;
uniform float distortion_severity : hint_range(0.0, 1.0) = 0.1;
uniform int iterations : hint_range(1, 10) = 3;
uniform float speed : hint_range(0.1, 2.0) = 0.4;

const float PI = 3.1415926535897;

float get_curve(float f)
{
	return
		(smoothstep(0.0, 0.5, f) - smoothstep(0.5, 1.0, f)) *
		(1.0 + added_threshold) - added_threshold / 2.0;
}

void fragment()
{
	float div = 1.0 / float(iterations - 1);
	float result = 1.0;
	float primary_factor, n = 0.0, ftime, itime, f;
	vec2 noise_pos;
	
	vec4 image = texture(TEXTURE, UV);
	vec2 uv = UV * 2.0 - 1.0;
	uv += normalize(uv) * (1.0 - image.a);
	uv = uv * 0.5 + 0.5;
	
	for (int i = 0; i < iterations; i++)
	{
		f = float(i);
		ftime = fract(TIME * speed + div * f);
		itime = floor(TIME * speed + div * f + f);
		primary_factor = get_curve(ftime);
		noise_pos = mod(uv * noisiness + noisiness * (itime + float(iterations)), noisiness * float(iterations));
		n = clamp(n + step(noise(noise_pos), primary_factor * 0.5), 0.0, 1.0);
	}
	
	COLOR = image * mix(light_color, dark_color, 1.0 - n);
}"

[sub_resource type="ShaderMaterial" id=2]
shader = SubResource( 3 )
shader_param/light_color = Color( 0.136107, 0.1232, 0.22, 1 )
shader_param/dark_color = Color( 0.0862745, 0.0901961, 0.168627, 1 )
shader_param/noisiness = 46.0
shader_param/added_threshold = 0.1
shader_param/hole_factor = 0.5
shader_param/distortion_severity = 0.168
shader_param/iterations = 3
shader_param/speed = 0.4

[node name="room" type="YSort"]
script = ExtResource( 2 )

[node name="npc" parent="." instance=ExtResource( 3 )]
visible = false
position = Vector2( 180, 132 )

[node name="animated_character_sprite_2d" parent="npc" index="0"]
frame = 2

[node name="warp" parent="npc" instance=ExtResource( 5 )]
map_path = "res://scenes/2d/maps/ghost_town_map.tscn"

[node name="below" type="Node2D" parent="."]
position = Vector2( 84, 36 )
__meta__ = {
"_edit_group_": true
}

[node name="DarkBackground" type="Sprite" parent="below"]
position = Vector2( 156, 156 )
texture = ExtResource( 4 )

[node name="BlueCircleEmpty" type="Sprite" parent="below"]
position = Vector2( 156, 156 )
texture = ExtResource( 1 )

[node name="SmallBlueParticles" type="Sprite" parent="below"]
position = Vector2( 156, 156 )
texture = ExtResource( 9 )
script = ExtResource( 15 )
rotation_speed = -15

[node name="SmallPinkParticles" type="Sprite" parent="below"]
position = Vector2( 156, 156 )
texture = ExtResource( 7 )
script = ExtResource( 15 )
rotation_speed = -15

[node name="BigBlueParticles" type="Sprite" parent="below"]
position = Vector2( 156, 156 )
texture = ExtResource( 8 )
script = ExtResource( 15 )
rotation_speed = 10

[node name="BigPinkParticles" type="Sprite" parent="below"]
position = Vector2( 156, 156 )
texture = ExtResource( 10 )
script = ExtResource( 15 )
rotation_speed = 10

[node name="Cross" type="Sprite" parent="below"]
material = SubResource( 2 )
position = Vector2( 156, 156 )
texture = ExtResource( 11 )

[node name="PinkCircle" type="Sprite" parent="below"]
position = Vector2( 156, 156 )
texture = ExtResource( 12 )

[node name="HubPattern" type="Sprite" parent="below"]
position = Vector2( 156, 156 )
texture = ExtResource( 14 )

[node name="above" type="Node2D" parent="."]
position = Vector2( -12, 12 )
z_index = 1

[node name="solid_grid_2d" parent="above" instance=ExtResource( 6 )]
position = Vector2( -144, 60 )

[editable path="npc"]
